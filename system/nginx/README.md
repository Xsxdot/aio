# Nginx 配置管理组件

本组件用于管理本机 Linux 系统的 Nginx 配置文件（`*.conf`）。

## 功能概述

- **CRUD 操作**：对配置目录（默认 `/etc/nginx/conf.d`）下的 `*.conf` 文件进行创建、读取、更新、删除
- **参数化生成**：通过结构化参数自动生成配置文件内容，支持反向代理、upstream、静态站点三种模板
- **自动校验**：变更后自动执行 `nginx -t` 校验配置语法
- **自动重载**：校验通过后自动执行 `nginx -s reload` 应用配置
- **失败回滚**：校验失败时自动回滚到原配置，确保服务稳定

## 安全约束

1. **仅管理指定目录**：只允许操作 `root_dir` 配置的目录（默认 `/etc/nginx/conf.d`）
2. **文件名校验**：配置文件名必须以 `.conf` 结尾，不能包含路径分隔符或 `..`
3. **原子写入**：使用"写临时文件 -> rename"的方式，避免半写入导致配置损坏

## 配置

在 `resources/*.yaml` 中添加 `nginx` 配置段：

```yaml
nginx:
  root_dir: '/etc/nginx/conf.d'  # 配置文件根目录（仅管理此目录下的 *.conf）
  validate_command: 'nginx -t'  # 配置校验命令
  reload_command: 'nginx -s reload'  # 配置重载命令（可改为 systemctl reload nginx）
  command_timeout: 30s  # 命令执行超时时间
  file_mode: '0644'  # 配置文件权限
```

## HTTP API

所有接口挂载在 `/admin/nginx/configs`，需要相应权限。

### 权限点

| 权限点 | 说明 |
|--------|------|
| `admin:nginx:config:read` | 查询配置文件列表、详情 |
| `admin:nginx:config:create` | 创建配置文件 |
| `admin:nginx:config:update` | 更新配置文件 |
| `admin:nginx:config:delete` | 删除配置文件 |

### 接口列表

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| POST | `/` | create | 创建配置文件（直接传 content） |
| POST | `/generate` | create | 按参数生成并创建配置文件 |
| PUT | `/:name` | update | 更新配置文件内容（直接传 content） |
| PUT | `/:name/generate` | update | 按参数生成并更新配置文件 |
| DELETE | `/:name` | delete | 删除配置文件 |
| GET | `/` | read | 列表/分页/搜索 |
| GET | `/:name` | read | 获取配置文件详情 |

## 请求/响应示例

### 创建配置文件

```http
POST /admin/nginx/configs
Content-Type: application/json

{
  "name": "example.com.conf",
  "content": "# Description: example.com 站点配置\nserver {\n    listen 80;\n    server_name example.com;\n    location / {\n        proxy_pass http://127.0.0.1:8080;\n    }\n}"
}
```

### 查询列表

```http
GET /admin/nginx/configs?keyword=example&pageNum=1&size=20
```

响应：
```json
{
  "code": 200,
  "data": {
    "total": 5,
    "content": [
      {
        "name": "example.com.conf",
        "description": "example.com 站点配置",
        "modTime": "2024-01-15 10:30:00"
      }
    ]
  }
}
```

### 获取配置详情

```http
GET /admin/nginx/configs/example.com.conf
```

响应：
```json
{
  "code": 200,
  "data": {
    "name": "example.com.conf",
    "content": "# Description: example.com 站点配置\nserver {\n    ...\n}",
    "description": "example.com 站点配置",
    "modTime": "2024-01-15 10:30:00"
  }
}
```

### 更新配置文件

```http
PUT /admin/nginx/configs/example.com.conf
Content-Type: application/json

{
  "content": "# Description: example.com 站点配置（更新）\nserver {\n    listen 80;\n    listen 443 ssl;\n    server_name example.com;\n    ...\n}"
}
```

### 删除配置文件

```http
DELETE /admin/nginx/configs/example.com.conf
```

## 参数化生成接口

支持通过结构化参数自动生成 nginx 配置文件，避免手写配置。

### 配置类型

| 类型 | 说明 |
|------|------|
| `proxy` | 反向代理站点，支持 proxy_pass、WebSocket 头等 |
| `static` | 静态站点，支持 root、index、try_files 等 |

### 按参数创建配置文件（反向代理示例）

```http
POST /admin/nginx/configs/generate
Content-Type: application/json

{
  "name": "api.example.com.conf",
  "spec": {
    "type": "proxy",
    "description": "API 反向代理",
    "server": {
      "listen": 80,
      "serverName": "api.example.com",
      "locations": [
        {
          "path": "/",
          "proxyPass": "http://127.0.0.1:8080",
          "enableWebSocket": true
        }
      ]
    }
  }
}
```

生成的配置内容：

```nginx
# Description: API 反向代理
# Type: proxy
# Generated by NginxConfigGenerateService

server {
    listen 80;
    server_name api.example.com;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

}
```

### 按参数创建配置文件（带 upstream 示例）

```http
POST /admin/nginx/configs/generate
Content-Type: application/json

{
  "name": "app.example.com.conf",
  "spec": {
    "type": "proxy",
    "description": "应用负载均衡",
    "upstreams": [
      {
        "name": "app_backend",
        "loadBalance": "least_conn",
        "servers": [
          { "address": "10.0.0.1:8080", "weight": 3 },
          { "address": "10.0.0.2:8080", "weight": 2 },
          { "address": "10.0.0.3:8080", "backup": true }
        ]
      }
    ],
    "server": {
      "listen": 80,
      "serverName": "app.example.com",
      "locations": [
        {
          "path": "/",
          "proxyPass": "http://app_backend"
        }
      ]
    }
  }
}
```

生成的配置内容：

```nginx
# Description: 应用负载均衡
# Type: proxy
# Generated by NginxConfigGenerateService

upstream app_backend {
    least_conn;
    server 10.0.0.1:8080 weight=3;
    server 10.0.0.2:8080 weight=2;
    server 10.0.0.3:8080 backup;
}

server {
    listen 80;
    server_name app.example.com;

    location / {
        proxy_pass http://app_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

}
```

### 按参数创建配置文件（静态站点示例）

```http
POST /admin/nginx/configs/generate
Content-Type: application/json

{
  "name": "static.example.com.conf",
  "spec": {
    "type": "static",
    "description": "静态资源站点",
    "server": {
      "listen": 80,
      "serverName": "static.example.com",
      "locations": [
        {
          "path": "/",
          "root": "/var/www/static",
          "index": "index.html",
          "tryFiles": "$uri $uri/ /index.html"
        }
      ]
    }
  }
}
```

生成的配置内容：

```nginx
# Description: 静态资源站点
# Type: static
# Generated by NginxConfigGenerateService

server {
    listen 80;
    server_name static.example.com;

    location / {
        root /var/www/static;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

}
```

### 按参数更新配置文件

```http
PUT /admin/nginx/configs/api.example.com.conf/generate
Content-Type: application/json

{
  "spec": {
    "type": "proxy",
    "description": "API 反向代理（更新）",
    "server": {
      "listen": 443,
      "serverName": "api.example.com",
      "sslEnabled": true,
      "sslCert": "/etc/ssl/certs/api.example.com.crt",
      "sslKey": "/etc/ssl/private/api.example.com.key",
      "locations": [
        {
          "path": "/",
          "proxyPass": "http://127.0.0.1:8080"
        }
      ]
    }
  }
}
```

### ConfigSpec 参数说明

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `type` | string | 是 | 配置类型：`proxy` 或 `static` |
| `description` | string | 否 | 配置描述（会写入注释） |
| `upstreams` | array | 否 | upstream 配置列表 |
| `server` | object | 是 | server 配置 |

#### ServerConfig

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `listen` | int | 是 | 监听端口（1-65535） |
| `serverName` | string | 是 | 域名（多个用空格分隔） |
| `locations` | array | 是 | location 配置列表 |
| `sslEnabled` | bool | 否 | 是否启用 SSL |
| `sslCert` | string | 否 | SSL 证书路径 |
| `sslKey` | string | 否 | SSL 私钥路径 |

#### UpstreamConfig

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `name` | string | 是 | upstream 名称 |
| `servers` | array | 是 | 后端服务器列表 |
| `loadBalance` | string | 否 | 负载均衡算法：`ip_hash` 或 `least_conn` |

#### LocationConfig

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `path` | string | 是 | 匹配路径（如 `/` 或 `/api`） |
| `proxyPass` | string | proxy 必填 | 代理目标 |
| `enableWebSocket` | bool | 否 | 是否启用 WebSocket 支持 |
| `root` | string | static 可选 | 静态文件根目录 |
| `index` | string | static 可选 | 索引文件 |
| `tryFiles` | string | static 可选 | try_files 规则 |

## 运维要求

该服务进程需要具备以下权限：

1. **写入权限**：`root_dir` 配置的目录（默认 `/etc/nginx/conf.d`）
2. **执行权限**：`nginx` 命令（或 `validate_command` / `reload_command` 配置的命令）

建议配置方式：
- 以 root 用户运行
- 或通过 sudoers 精确授权（仅 nginx 命令 + 目标目录写权限）

## 目录结构

```
system/nginx/
├── module.go                              # 模块门面
├── router.go                              # 路由注册入口
├── README.md                              # 本文档
├── api/
│   ├── client/
│   │   └── nginx_client.go                # 对外客户端
│   └── dto/
│       └── nginx_dto.go                   # 对外 DTO
├── internal/
│   ├── app/
│   │   └── app.go                         # 应用层编排
│   ├── model/
│   │   └── dto/
│   │       ├── nginx_dto.go               # 请求/响应 DTO
│   │       └── config_spec.go             # 配置规格结构体（ConfigSpec 等）
│   └── service/
│       ├── nginx_file_service.go          # 配置文件 CRUD
│       ├── nginx_command_service.go       # nginx 命令封装
│       └── nginx_config_generate_service.go # 配置内容生成（纯逻辑）
└── external/
    └── http/
        └── config_controller.go           # HTTP 控制器
```

## 配置变更流程

```
1. 用户提交配置变更
       ↓
2. 写入配置文件（原子写入）
       ↓
3. 执行 validate_command (nginx -t)
       ↓
   ┌───┴───┐
   ↓       ↓
 成功    失败
   ↓       ↓
4. 执行    回滚（恢复旧文件或删除新文件）
   reload_command
   ↓       ↓
5. 返回    返回错误
   成功
```

## 平台兼容性

- **Linux**：完全支持
- **macOS/Windows**：编译通过，但运行时会返回"仅支持 Linux 平台"错误

## 描述解析

配置文件内容可以包含描述注释，格式为：
- `# Description: xxx`
- `# 描述: xxx`

该描述会在列表查询时返回，便于管理。
