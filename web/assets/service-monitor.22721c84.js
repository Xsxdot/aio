import{d as F,l as w}from"./distributed.0f0884be.js";import{v as D,w as A}from"./monitor.07efdc4f.js";function h(e){return console.log("\u63D0\u53D6\u6570\u636E\uFF0C\u539F\u59CB\u54CD\u5E94:",e),e&&e.data!==void 0?(console.log("\u4ECE response.data \u63D0\u53D6\u6570\u636E"),e.data):e&&e.code!==void 0&&e.data!==void 0?(console.log("\u4ECE API \u54CD\u5E94\u5BF9\u8C61\u63D0\u53D6 data \u5B57\u6BB5"),e.data):(console.log("\u65E0\u6CD5\u63D0\u53D6\u6570\u636E\uFF0C\u8FD4\u56DE\u539F\u59CB\u54CD\u5E94"),e)}function b(e){return async(...c)=>{const m=await e(...c);return h(m)}}async function S(e="1h"){try{const c=await w();console.log(c);const m=h(c);if(!m)return console.error("\u670D\u52A1\u5217\u8868\u4E3A\u7A7A"),[];const l=[],a=new Map;if(typeof m=="object"&&!Array.isArray(m)){console.log("\u5904\u7406\u5BF9\u8C61\u683C\u5F0F\u7684\u670D\u52A1\u5217\u8868: {\u670D\u52A1\u540D\u79F0: \u5B9E\u4F8B\u6570\u7EC4}");for(const[n,t]of Object.entries(m)){if(!Array.isArray(t)){console.error(`\u670D\u52A1 ${n} \u7684\u5B9E\u4F8B\u5217\u8868\u4E0D\u662F\u6570\u7EC4:`,t);continue}a.set(n,t)}}else if(Array.isArray(m))console.log("\u5904\u7406\u6570\u7EC4\u683C\u5F0F\u7684\u670D\u52A1\u5217\u8868: [\u670D\u52A1\u5B9E\u4F8B]"),m.forEach(n=>{var t;a.has(n.name)||a.set(n.name,[]),(t=a.get(n.name))==null||t.push(n)});else return console.error("\u670D\u52A1\u5217\u8868\u683C\u5F0F\u65E0\u6CD5\u5904\u7406:",m),[];for(const[n,t]of a.entries()){const i={name:n,instances:t.map(u=>({id:u.id,address:u.address,port:u.port,healthStatus:"unknown",lastActive:u.registerTime})),endpoints:[]};t.length>0&&t[0].metadata&&(i.description=t[0].metadata.description,i.version=t[0].metadata.version,i.tags=t[0].metadata.tags);try{const u=await D(`-${e}`,void 0,!0,n),r=h(u);if(r!=null&&r.series){const s=new Map;r.series.forEach(o=>{const p=o.labels.endpoint||"",d=o.labels.method||"GET";s.has(`${d}:${p}`)||s.set(`${d}:${p}`,{path:p,method:d,metrics:{responseTime:0,callCount:0,errorRate:0},trend:[]});const f=s.get(`${d}:${p}`);!f||(o.name==="api.request.duration"?(f.metrics.responseTime=E(o.points),f.trend=o.points):o.name==="api.request.count"?f.metrics.callCount=g(o.points):o.name==="api.request.error"&&(f.metrics.errorRate=y(o.points)))}),i.endpoints=Array.from(s.values()),i.metrics={totalCalls:i.endpoints.reduce((o,p)=>{var d;return o+(((d=p.metrics)==null?void 0:d.callCount)||0)},0),avgResponseTime:C(i.endpoints),errorRate:v(i.endpoints),qps:B(i.endpoints)}}}catch(u){console.error(`\u83B7\u53D6\u670D\u52A1 ${n} \u7684API\u8C03\u7528\u6570\u636E\u5931\u8D25:`,u)}for(const u of i.instances)try{const r=await A("app.cpu.usage,app.memory.used,app.thread.total",`-${e}`,void 0,n,u.id),s=h(r);if(s!=null&&s.series&&(u.resources={cpu:0,memory:0},u.runtime={threads:0,memory:0},s.series.forEach(o=>{const p=o.points.length>0?o.points[o.points.length-1].value:0;o.name==="app.cpu.usage"?u.resources.cpu=p:o.name==="app.memory.used"?(u.resources.memory=p,u.runtime.memory=p):o.name==="app.thread.total"&&(u.runtime.threads=p)}),s.series.length>0&&s.series[0].points.length>0)){const o=s.series[0].points[s.series[0].points.length-1],p=typeof o.timestamp=="string"?new Date(o.timestamp).getTime():o.timestamp,f=Date.now()-p;u.healthStatus=f<5*60*1e3?"healthy":"unhealthy",u.lastActive=new Date(p).toISOString()}}catch(r){console.error(`\u83B7\u53D6\u5B9E\u4F8B ${u.id} \u7684\u76D1\u63A7\u6570\u636E\u5931\u8D25:`,r)}l.push(i)}return l}catch(c){return console.error("\u83B7\u53D6\u5E94\u7528\u670D\u52A1\u5217\u8868\u5931\u8D25:",c),[]}}async function $(e,c="1h"){try{const m=await F(e),l=h(m);let a=[];if(Array.isArray(l))console.log("\u5904\u7406\u6570\u7EC4\u683C\u5F0F\u7684\u670D\u52A1\u5B9E\u4F8B"),a=l;else if(typeof l=="object"&&l!==null){console.log("\u5904\u7406\u5BF9\u8C61\u683C\u5F0F\u7684\u670D\u52A1\u5B9E\u4F8B");const t=l[e];Array.isArray(t)&&(a=t)}if(a.length===0)return console.error("\u672A\u627E\u5230\u670D\u52A1\u5B9E\u4F8B",e),null;const n={name:e,instances:a.map(t=>({id:t.id,address:t.address,port:t.port,healthStatus:"unknown",lastActive:t.registerTime})),endpoints:[]};a.length>0&&a[0].metadata&&(n.description=a[0].metadata.description,n.version=a[0].metadata.version,n.tags=a[0].metadata.tags);try{const t=await D(`-${c}`,void 0,!0,e),i=h(t);if(i!=null&&i.series){const u=new Map;i.series.forEach(r=>{const s=r.labels.endpoint||"",o=r.labels.method||"GET";u.has(`${o}:${s}`)||u.set(`${o}:${s}`,{path:s,method:o,metrics:{responseTime:0,callCount:0,errorRate:0},trend:[]});const p=u.get(`${o}:${s}`);!p||(r.name==="api.request.duration"?(p.metrics.responseTime=E(r.points),p.trend=r.points):r.name==="api.request.count"?p.metrics.callCount=g(r.points):r.name==="api.request.error"&&(p.metrics.errorRate=y(r.points)))}),n.endpoints=Array.from(u.values()),n.metrics={totalCalls:n.endpoints.reduce((r,s)=>{var o;return r+(((o=s.metrics)==null?void 0:o.callCount)||0)},0),avgResponseTime:C(n.endpoints),errorRate:v(n.endpoints),qps:B(n.endpoints)}}}catch(t){console.error(`\u83B7\u53D6\u670D\u52A1 ${e} \u7684API\u8C03\u7528\u6570\u636E\u5931\u8D25:`,t)}for(const t of n.instances)try{const i=await A("app.cpu.usage,app.memory.used,app.thread.total,app.gc.count",`-${c}`,void 0,e,t.id),u=h(i);if(u!=null&&u.series&&(t.resources={cpu:0,memory:0},t.runtime={threads:0,memory:0,gc:0},u.series.forEach(r=>{const s=r.points.length>0?r.points[r.points.length-1].value:0;r.name==="app.cpu.usage"?t.resources.cpu=s:r.name==="app.memory.used"?(t.resources.memory=s,t.runtime.memory=s):r.name==="app.thread.total"?t.runtime.threads=s:r.name==="app.gc.count"&&(t.runtime.gc=s)}),u.series.length>0&&u.series[0].points.length>0)){const r=u.series[0].points[u.series[0].points.length-1],s=typeof r.timestamp=="string"?new Date(r.timestamp).getTime():r.timestamp,p=Date.now()-s;t.healthStatus=p<5*60*1e3?"healthy":"unhealthy",t.lastActive=new Date(s).toISOString()}}catch(i){console.error(`\u83B7\u53D6\u5B9E\u4F8B ${t.id} \u7684\u76D1\u63A7\u6570\u636E\u5931\u8D25:`,i)}return n}catch(m){return console.error(`\u83B7\u53D6\u5E94\u7528\u670D\u52A1 ${e} \u8BE6\u60C5\u5931\u8D25:`,m),null}}function E(e){return e.length===0?0:e.reduce((m,l)=>m+l.value,0)/e.length}function g(e){return e.reduce((c,m)=>c+m.value,0)}function y(e){if(e.length===0)return 0;const c=g(e);return Math.min(c/100,1)}function C(e){const c=e.filter(l=>{var a;return(a=l.metrics)==null?void 0:a.responseTime}).map(l=>l.metrics.responseTime);return c.length===0?0:c.reduce((l,a)=>l+a,0)/c.length}function v(e){const c=e.reduce((l,a)=>{var n;return l+(((n=a.metrics)==null?void 0:n.callCount)||0)},0);return c===0?0:e.reduce((l,a)=>{var i,u;const n=((i=a.metrics)==null?void 0:i.errorRate)||0,t=((u=a.metrics)==null?void 0:u.callCount)||0;return l+n*t},0)/c}function B(e){return e.reduce((m,l)=>{var a;return m+(((a=l.metrics)==null?void 0:a.callCount)||0)},0)/3600}const M=Object.freeze(Object.defineProperty({__proto__:null,getAllAppServices:S,getAppServiceDetail:$},Symbol.toStringTag,{value:"Module"}));export{$ as g,M as s,b as w};
