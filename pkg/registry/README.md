# æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒ

åŸºäºETCDçš„åˆ†å¸ƒå¼æœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒï¼Œæä¾›é«˜å¯ç”¨çš„æœåŠ¡ç®¡ç†èƒ½åŠ›ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ” **æœåŠ¡æ³¨å†Œä¸å‘ç°**: æ”¯æŒæœåŠ¡å®ä¾‹çš„æ³¨å†Œã€æ³¨é”€å’Œå‘ç°
- â±ï¸ **æœåŠ¡è¿è¡Œæ—¶é—´è·Ÿè¸ª**: è‡ªåŠ¨è®°å½•æœåŠ¡å¯åŠ¨æ—¶é—´å’Œæ³¨å†Œæ—¶é—´ï¼Œæä¾›è¿è¡Œæ—¶é•¿æŸ¥è¯¢
- ğŸ”„ **çŠ¶æ€ç®¡ç†**: æœåŠ¡çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œæ”¯æŒåœ¨çº¿/ç¦»çº¿çŠ¶æ€åˆ‡æ¢
- ğŸ‘ï¸ **å®æ—¶ç›‘å¬**: æ”¯æŒæœåŠ¡å˜æ›´çš„å®æ—¶ç›‘å¬å’Œé€šçŸ¥
- âš–ï¸ **è´Ÿè½½å‡è¡¡**: æ”¯æŒæœåŠ¡æƒé‡é…ç½®ï¼Œä¾¿äºè´Ÿè½½å‡è¡¡å®ç°
- ğŸ“Š **å¥åº·æ£€æŸ¥**: åŸºäºå¿ƒè·³ç»­çº¦çš„æœåŠ¡å¥åº·çŠ¶æ€ç®¡ç†
- ğŸ• **è‡ªåŠ¨ç¦»çº¿**: é€šè¿‡è°ƒåº¦å™¨å®šæ—¶æ£€æŸ¥ï¼Œå°†é•¿æ—¶é—´æœªç»­çº¦çš„æœåŠ¡è‡ªåŠ¨æ ‡è®°ä¸ºç¦»çº¿çŠ¶æ€
- ğŸ·ï¸ **å…ƒæ•°æ®æ”¯æŒ**: æ”¯æŒè‡ªå®šä¹‰æœåŠ¡å…ƒæ•°æ®
- ğŸ”’ **å¹¶å‘å®‰å…¨**: çº¿ç¨‹å®‰å…¨çš„æ“ä½œï¼Œæ”¯æŒå¹¶å‘è®¿é—®
- ğŸ”„ **æ•…éšœæ¢å¤**: æ”¯æŒæœåŠ¡å¼‚å¸¸æ—¶çš„è‡ªåŠ¨é‡æ–°æ³¨å†Œ

## æ ¸å¿ƒæ¦‚å¿µ

### çŠ¶æ€ç®¡ç†æœºåˆ¶

æœ¬ç»„ä»¶ä½¿ç”¨çŠ¶æ€ç®¡ç†æœºåˆ¶æ¥ç®¡ç†æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸï¼š

- **çŠ¶æ€è·Ÿè¸ª**: æœåŠ¡æ³¨å†Œæ—¶ç›´æ¥ä¿å­˜åœ¨ETCDä¸­ï¼Œä¸ä½¿ç”¨ç§Ÿçº¦
- **å¿ƒè·³ç»­çº¦**: å®¢æˆ·ç«¯éœ€è¦å®šæœŸè°ƒç”¨`Renew`æ–¹æ³•æ›´æ–°æœåŠ¡çŠ¶æ€å’Œç»­çº¦æ—¶é—´
- **è°ƒåº¦ç›‘æ§**: é€šè¿‡è°ƒåº¦å™¨åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæ£€æŸ¥æœåŠ¡ç»­çº¦çŠ¶æ€
- **è‡ªåŠ¨ç¦»çº¿**: é•¿æ—¶é—´æœªç»­çº¦çš„æœåŠ¡ä¼šè¢«è°ƒåº¦å™¨è‡ªåŠ¨æ ‡è®°ä¸ºç¦»çº¿çŠ¶æ€ï¼Œä½†ä¸ä¼šåˆ é™¤
- **ç‰©ç†åˆ é™¤**: åªæœ‰ä¸»åŠ¨è°ƒç”¨`Unregister`æ–¹æ³•æ‰ä¼šç‰©ç†åˆ é™¤æœåŠ¡è®°å½•

### æœåŠ¡å®ä¾‹

æ¯ä¸ªæœåŠ¡å®ä¾‹åŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

- **åŸºæœ¬ä¿¡æ¯**: IDã€åç§°ã€åœ°å€ã€åè®®
- **æ—¶é—´ä¿¡æ¯**: æ³¨å†Œæ—¶é—´ã€å¯åŠ¨æ—¶é—´ã€æœ€åç»­çº¦æ—¶é—´ã€ä¸‹çº¿æ—¶é—´
- **çŠ¶æ€ä¿¡æ¯**: æœåŠ¡çŠ¶æ€ã€è´Ÿè½½æƒé‡
- **å…ƒæ•°æ®**: è‡ªå®šä¹‰çš„é”®å€¼å¯¹ä¿¡æ¯

## å¿«é€Ÿå¼€å§‹

### 1. åˆ›å»ºæ³¨å†Œä¸­å¿ƒ

```go
package main

import (
    "context"
    "time"
    
    "github.com/xsxdot/aio/app/config"
    "github.com/xsxdot/aio/internal/etcd"
    "github.com/xsxdot/aio/pkg/registry"
    "github.com/xsxdot/aio/pkg/scheduler"
    "github.com/xsxdot/aio/pkg/lock"
)

func main() {
    // åˆ›å»ºETCDå®¢æˆ·ç«¯
    etcdClient, err := etcd.NewClient(&config.EtcdConfig{
        Endpoints:   []string{"localhost:2379"},
        DialTimeout: 5 * time.Second,
    })
    if err != nil {
        panic(err)
    }
    defer etcdClient.Close()

    // åˆ›å»ºåˆ†å¸ƒå¼é”ç®¡ç†å™¨
    lockManager := lock.NewEtcdLockManager(etcdClient)

    // åˆ›å»ºè°ƒåº¦å™¨ï¼ˆå¦‚æœéœ€è¦ç›‘æ§è¿‡æœŸæœåŠ¡ï¼‰
    schedulerInstance := scheduler.NewScheduler(lockManager, scheduler.DefaultSchedulerConfig())
    if err := schedulerInstance.Start(); err != nil {
        panic(err)
    }
    defer schedulerInstance.Stop()

    // åˆ›å»ºæ³¨å†Œä¸­å¿ƒ
    reg, err := registry.NewRegistry(etcdClient, schedulerInstance,
        registry.WithLeaseTTL(30),                    // 30ç§’è¶…æ—¶é˜ˆå€¼
        registry.WithRenewInterval(10*time.Second),   // æ¯10ç§’ç»­çº¦
        registry.WithPrefix("/my-app/services"),      // è‡ªå®šä¹‰å‰ç¼€
    )
    if err != nil {
        panic(err)
    }
    defer reg.Close()
}
```

### 2. æ³¨å†ŒæœåŠ¡

```go
// åˆ›å»ºæœåŠ¡å®ä¾‹
instance := &registry.ServiceInstance{
    ID:       "user-service-001",
    Name:     "user-service",
    Address:  "127.0.0.1:8080",
    Protocol: "http",
    Status:   "active",
    Weight:   100,
    Metadata: map[string]string{
        "version": "1.0.0",
        "env":     "production",
    },
}

// æ³¨å†ŒæœåŠ¡
ctx := context.Background()
err := reg.Register(ctx, instance)
if err != nil {
    panic(err)
}
```

### 3. å®¢æˆ·ç«¯ä¸»åŠ¨ç»­çº¦

```go
// æ–¹å¼1: æ‰‹åŠ¨ç»­çº¦
go func() {
    ticker := time.NewTicker(10 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ticker.C:
            if err := reg.Renew(ctx, instance.ID); err != nil {
                log.Printf("ç»­çº¦å¤±è´¥: %v", err)
                // å¦‚æœæœåŠ¡ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°æ³¨å†Œ
                if err.Error() == "service not found" {
                    if err := reg.Register(ctx, instance); err != nil {
                        log.Printf("é‡æ–°æ³¨å†Œå¤±è´¥: %v", err)
                    }
                }
            }
        }
    }
}()

// æ–¹å¼2: ä½¿ç”¨ä¾¿æ·å‡½æ•°
stopRenew := registry.RenewService(reg, instance.ID, 10*time.Second)
defer stopRenew() // åœæ­¢ç»­çº¦
```

### 4. å‘ç°æœåŠ¡

```go
// å‘ç°æœåŠ¡å®ä¾‹
instances, err := reg.Discover(ctx, "user-service")
if err != nil {
    panic(err)
}

for _, inst := range instances {
    fmt.Printf("æœåŠ¡: %s, åœ°å€: %s, è¿è¡Œæ—¶é•¿: %v\n", 
        inst.ID, inst.Address, inst.GetUptime())
}
```

### 5. ç›‘å¬æœåŠ¡å˜æ›´

```go
// åˆ›å»ºç›‘å¬å™¨
watcher, err := reg.Watch(ctx, "user-service")
if err != nil {
    panic(err)
}
defer watcher.Stop()

// ç›‘å¬å˜æ›´
go func() {
    for {
        instances, err := watcher.Next()
        if err != nil {
            log.Printf("ç›‘å¬é”™è¯¯: %v", err)
            break
        }
        
        fmt.Printf("æœåŠ¡å˜æ›´ï¼Œå½“å‰å®ä¾‹æ•°: %d\n", len(instances))
    }
}()
```

## API å‚è€ƒ

### Registry æ¥å£

```go
type Registry interface {
    // æ³¨å†ŒæœåŠ¡å®ä¾‹
    Register(ctx context.Context, instance *ServiceInstance) error
    
    // æ³¨é”€æœåŠ¡å®ä¾‹ï¼ˆç‰©ç†åˆ é™¤ï¼‰
    Unregister(ctx context.Context, serviceID string) error
    
    // ä¸‹çº¿æœåŠ¡å®ä¾‹ï¼ˆé€»è¾‘åˆ é™¤ï¼Œä¿ç•™è®°å½•ï¼‰
    Offline(ctx context.Context, serviceID string) (*ServiceInstance, error)
    
    // ç»­çº¦æœåŠ¡å®ä¾‹
    Renew(ctx context.Context, serviceID string) error
    
    // å‘ç°æœåŠ¡å®ä¾‹åˆ—è¡¨
    Discover(ctx context.Context, serviceName string) ([]*ServiceInstance, error)
    
    // ç›‘å¬æœåŠ¡å˜æ›´
    Watch(ctx context.Context, serviceName string) (Watcher, error)
    
    // è·å–å•ä¸ªæœåŠ¡å®ä¾‹
    GetService(ctx context.Context, serviceID string) (*ServiceInstance, error)
    
    // åˆ—å‡ºæ‰€æœ‰æœåŠ¡åç§°
    ListServices(ctx context.Context) ([]string, error)
    
    // å…³é—­æ³¨å†Œä¸­å¿ƒ
    Close() error
}
```

### ServiceInstance ç»“æ„

```go
type ServiceInstance struct {
    ID           string            `json:"id"`            // æœåŠ¡å®ä¾‹ID
    Name         string            `json:"name"`          // æœåŠ¡åç§°
    Address      string            `json:"address"`       // æœåŠ¡åœ°å€
    Protocol     string            `json:"protocol"`      // åè®®ç±»å‹
    RegisterTime time.Time         `json:"register_time"` // æ³¨å†Œæ—¶é—´
    StartTime    time.Time         `json:"start_time"`    // å¯åŠ¨æ—¶é—´
    Metadata     map[string]string `json:"metadata"`      // å…ƒæ•°æ®
    Weight       int               `json:"weight"`        // æƒé‡
    Status       string            `json:"status"`        // çŠ¶æ€
}
```

## é…ç½®é€‰é¡¹

| é€‰é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| Prefix | string | "/aio/registry" | ETCDé”®å‰ç¼€ |
| LeaseTTL | int64 | 30 | ç§Ÿçº¦ç”Ÿå­˜æ—¶é—´(ç§’) |
| KeepAlive | bool | true | æ˜¯å¦å¯ç”¨ç»­çº¦ |
| RenewInterval | time.Duration | 10s | ç»­çº¦é—´éš”æ—¶é—´ |
| RetryTimes | int | 3 | é‡è¯•æ¬¡æ•° |
| RetryDelay | time.Duration | 1s | é‡è¯•å»¶è¿Ÿ |

## æœ€ä½³å®è·µ

### 1. ç»­çº¦ç­–ç•¥

- **ç»­çº¦é—´éš”**: å»ºè®®è®¾ç½®ä¸ºç§Ÿçº¦TTLçš„1/3ï¼Œç¡®ä¿æœ‰è¶³å¤Ÿçš„é‡è¯•æœºä¼š
- **é”™è¯¯å¤„ç†**: ç»­çº¦å¤±è´¥æ—¶å¯ä»¥é€‰æ‹©é‡æ–°æ³¨å†ŒæœåŠ¡
- **èµ„æºæ¸…ç†**: æœåŠ¡åœæ­¢æ—¶è®°å¾—è°ƒç”¨åœæ­¢ç»­çº¦å‡½æ•°

```go
// æ¨èçš„ç»­çº¦é…ç½®
registry.WithLeaseTTL(30),                    // 30ç§’ç§Ÿçº¦
registry.WithRenewInterval(10*time.Second),   // 10ç§’ç»­çº¦é—´éš”
```

### 2. æœåŠ¡æ³¨å†Œ

- **å”¯ä¸€ID**: ç¡®ä¿æœåŠ¡å®ä¾‹IDçš„å”¯ä¸€æ€§
- **è¯¦ç»†å…ƒæ•°æ®**: æä¾›è¶³å¤Ÿçš„å…ƒæ•°æ®ä¿¡æ¯ä¾¿äºæœåŠ¡å‘ç°
- **åˆç†æƒé‡**: æ ¹æ®æœåŠ¡èƒ½åŠ›è®¾ç½®æƒé‡å€¼

### 3. é”™è¯¯å¤„ç†

- **ç½‘ç»œå¼‚å¸¸**: å®ç°é‡è¯•æœºåˆ¶å¤„ç†ä¸´æ—¶ç½‘ç»œé—®é¢˜
- **ETCDæ•…éšœ**: è€ƒè™‘å®ç°ç†”æ–­æœºåˆ¶
- **ç§Ÿçº¦è¿‡æœŸ**: ç›‘æ§ç»­çº¦çŠ¶æ€ï¼ŒåŠæ—¶å¤„ç†å¼‚å¸¸

### 4. æ€§èƒ½ä¼˜åŒ–

- **æ‰¹é‡æ“ä½œ**: å¯¹äºå¤§é‡æœåŠ¡å‘ç°ï¼Œè€ƒè™‘ç¼“å­˜æœºåˆ¶
- **ç›‘å¬ä¼˜åŒ–**: åˆç†è®¾ç½®ç›‘å¬èŒƒå›´ï¼Œé¿å…ä¸å¿…è¦çš„äº‹ä»¶
- **è¿æ¥å¤ç”¨**: å…±äº«ETCDå®¢æˆ·ç«¯è¿æ¥

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **æœåŠ¡æ³¨å†Œå¤±è´¥**
   - æ£€æŸ¥ETCDè¿æ¥çŠ¶æ€
   - éªŒè¯æœåŠ¡å®ä¾‹æ•°æ®æ ¼å¼
   - ç¡®è®¤æƒé™é…ç½®

2. **ç»­çº¦å¤±è´¥**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤ç§Ÿçº¦æ˜¯å¦å·²è¿‡æœŸ
   - éªŒè¯æœåŠ¡IDæ˜¯å¦æ­£ç¡®

3. **æœåŠ¡å‘ç°å¼‚å¸¸**
   - æ£€æŸ¥æœåŠ¡åç§°æ˜¯å¦æ­£ç¡®
   - ç¡®è®¤æœåŠ¡æ˜¯å¦å·²æ³¨å†Œ
   - éªŒè¯é”®å‰ç¼€é…ç½®

### æ—¥å¿—é…ç½®

```go
// è®¾ç½®æ—¥å¿—å™¨è·å–è¯¦ç»†æ—¥å¿—
registry.SetLogger(logger)
```

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

# æœåŠ¡æ³¨å†Œä¸­å¿ƒ API æ–‡æ¡£

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æœåŠ¡æ³¨å†Œä¸­å¿ƒ (Registry) çš„ HTTP APIã€‚æ‰€æœ‰ API éƒ½éœ€è¦ç»è¿‡èº«ä»½éªŒè¯ï¼Œéƒ¨åˆ†ç®¡ç†å‘˜æ¥å£éœ€è¦é¢å¤–çš„ç®¡ç†å‘˜è§’è‰²æƒé™ã€‚

## ç»Ÿä¸€å“åº”æ ¼å¼

### æˆåŠŸå“åº”

```json
{
  "code": 20000,
  "msg": "success",
  "data": { ... }
}
```

### å¤±è´¥å“åº”

```json
{
  "code": "<error_code>",
  "msg": "<error_message>",
  "data": null
}
```

- `code`: ä¸šåŠ¡çŠ¶æ€ç ï¼Œ`20000` è¡¨ç¤ºæˆåŠŸï¼Œå…¶ä»–å€¼è¡¨ç¤ºå¤±è´¥ã€‚
- `msg`: æç¤ºä¿¡æ¯ã€‚
- `data`: æˆåŠŸæ—¶è¿”å›çš„æ•°æ®ã€‚

---

## 1. æœåŠ¡å®ä¾‹ç®¡ç†

### 1.1 æ³¨å†ŒæœåŠ¡å®ä¾‹

- **POST** `/registry/services`
- **æè¿°**: æ³¨å†Œä¸€ä¸ªæ–°çš„æœåŠ¡å®ä¾‹ã€‚æœåŠ¡å®ä¾‹IDå°†ç”±ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆã€‚
- **è®¤è¯**: éœ€è¦

#### è¯·æ±‚ä½“

```json
{
  "name": "user-service",
  "address": "127.0.0.1:8080",
  "protocol": "http",
  "metadata": {
    "version": "1.0.2",
    "region": "us-east-1"
  },
  "weight": 100,
  "status": "active"
}
```

| å­—æ®µ | ç±»å‹ | æ˜¯å¦å¿…é¡» | æè¿° |
| :--- | :--- | :--- | :--- |
| `name` | `string` | æ˜¯ | æœåŠ¡åç§°ï¼Œä¾‹å¦‚ `user-service`ã€‚ |
| `address` | `string` | æ˜¯ | æœåŠ¡åœ°å€ï¼Œæ ¼å¼ä¸º `host:port`ã€‚ |
| `protocol` | `string` | å¦ | åè®®ç±»å‹ï¼Œä¾‹å¦‚ `http`, `grpc`ã€‚é»˜è®¤ä¸º `http`ã€‚ |
| `metadata` | `object` | å¦ | æœåŠ¡å…ƒæ•°æ®ï¼Œé”®å€¼å¯¹å½¢å¼ã€‚ |
| `weight` | `integer`| å¦ | è´Ÿè½½å‡è¡¡æƒé‡ï¼Œé»˜è®¤ä¸º `100`ã€‚ |
| `status` | `string` | å¦ | æœåŠ¡çŠ¶æ€ï¼Œ`active`, `inactive`, `maintenance`ã€‚é»˜è®¤ä¸º `active`ã€‚ |

#### æˆåŠŸå“åº” (200 OK)

è¿”å›åˆ›å»ºçš„æœåŠ¡å®ä¾‹å¯¹è±¡ã€‚

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "id": "user-service-b2f7a9a8-c2b1-4a8a-9f0a-4f1e5e3b2e1a",
    "name": "user-service",
    "address": "127.0.0.1:8080",
    "protocol": "http",
    "register_time": "2023-10-27T10:00:00Z",
    "start_time": "2023-10-27T10:00:00Z",
    "metadata": {
      "version": "1.0.2",
      "region": "us-east-1"
    },
    "weight": 100,
    "status": "active"
  }
}
```

---

### 1.2 æ³¨é”€æœåŠ¡å®ä¾‹

- **DELETE** `/registry/services/:serviceID`
- **æè¿°**: æ ¹æ®æœåŠ¡å®ä¾‹IDæ³¨é”€ä¸€ä¸ªæœåŠ¡å®ä¾‹ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceID` | `string` | æœåŠ¡å®ä¾‹çš„å”¯ä¸€IDã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": "æœåŠ¡æ³¨é”€æˆåŠŸ"
}
```

---

### 1.3 ç»­çº¦æœåŠ¡å®ä¾‹

- **PUT** `/registry/services/:serviceID/renew`
- **æè¿°**: ä¸ºä¸€ä¸ªæœåŠ¡å®ä¾‹ç»­çº¦ç§ŸæœŸï¼Œé˜²æ­¢å…¶è¢«æ³¨é”€ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceID` | `string` | æœåŠ¡å®ä¾‹çš„å”¯ä¸€IDã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": "æœåŠ¡ç»­çº¦æˆåŠŸ"
}
```

---

### 1.4 è·å–å•ä¸ªæœåŠ¡å®ä¾‹

- **GET** `/registry/services/:serviceID`
- **æè¿°**: æ ¹æ®æœåŠ¡å®ä¾‹IDè·å–å…¶è¯¦ç»†ä¿¡æ¯ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceID` | `string` | æœåŠ¡å®ä¾‹çš„å”¯ä¸€IDã€‚ |

#### æˆåŠŸå“åº” (200 OK)

è¿”å›æœåŠ¡å®ä¾‹å¯¹è±¡ã€‚

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "id": "user-service-b2f7a9a8-c2b1-4a8a-9f0a-4f1e5e3b2e1a",
    "name": "user-service",
    "address": "127.0.0.1:8080",
    "protocol": "http",
    "register_time": "2023-10-27T10:00:00Z",
    "start_time": "2023-10-27T10:00:00Z",
    "metadata": {
      "version": "1.0.2",
      "region": "us-east-1"
    },
    "weight": 100,
    "status": "active"
  }
}
```

---

## 2. æœåŠ¡å‘ç°

### 2.1 åˆ—å‡ºæ‰€æœ‰æœåŠ¡åç§°

- **GET** `/registry/services`
- **æè¿°**: è·å–æ³¨å†Œä¸­å¿ƒæ‰€æœ‰ä¸é‡å¤çš„æœåŠ¡åç§°åˆ—è¡¨ã€‚
- **è®¤è¯**: éœ€è¦

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": [
    "user-service",
    "order-service",
    "product-service"
  ]
}
```

---

### 2.2 å‘ç°æœåŠ¡å®ä¾‹åˆ—è¡¨

- **GET** `/registry/discovery/:serviceName`
- **æè¿°**: æ ¹æ®æœåŠ¡åç§°å‘ç°æ‰€æœ‰å¥åº·çš„æœåŠ¡å®ä¾‹åˆ—è¡¨ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceName`| `string` | æœåŠ¡åç§°ã€‚ |

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | æ˜¯å¦å¿…é¡» | æè¿° |
| :--- | :--- | :--- | :--- |
| `status` | `string` | å¦ | æŒ‰æœåŠ¡çŠ¶æ€è¿‡æ»¤ï¼Œä¾‹å¦‚ `active`ã€‚ |
| `protocol` | `string` | å¦ | æŒ‰åè®®ç±»å‹è¿‡æ»¤ï¼Œä¾‹å¦‚ `grpc`ã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": [
    {
      "id": "user-service-b2f7a9a8-c2b1-4a8a-9f0a-4f1e5e3b2e1a",
      "name": "user-service",
      "address": "127.0.0.1:8080",
      "protocol": "http",
      ...
    },
    {
      "id": "user-service-a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "name": "user-service",
      "address": "127.0.0.1:8081",
      "protocol": "http",
      ...
    }
  ]
}
```

---

## 3. å¥åº·ä¸ç»Ÿè®¡

### 3.1 æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€

- **GET** `/registry/services/:serviceID/health`
- **æè¿°**: æ£€æŸ¥å•ä¸ªæœåŠ¡å®ä¾‹çš„å¥åº·çŠ¶æ€å’Œè¿è¡Œæ—¶é•¿ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceID` | `string` | æœåŠ¡å®ä¾‹çš„å”¯ä¸€IDã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "service_id": "user-service-b2f7a9a8-c2b1-4a8a-9f0a-4f1e5e3b2e1a",
    "service_name": "user-service",
    "status": "active",
    "healthy": true,
    "uptime": "3h25m10s",
    "register_duration": "3h25m10s",
    "last_check": "2023-10-27T13:25:10Z"
  }
}
```

---

### 3.2 è·å–æ³¨å†Œä¸­å¿ƒç»Ÿè®¡ä¿¡æ¯

- **GET** `/registry/stats`
- **æè¿°**: è·å–æ•´ä¸ªæ³¨å†Œä¸­å¿ƒçš„ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœåŠ¡æ€»æ•°ã€å®ä¾‹æ€»æ•°ç­‰ã€‚
- **è®¤è¯**: éœ€è¦

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "total_services": 3,
    "total_instances": 15,
    "healthy_instances": 14,
    "unhealthy_instances": 1,
    "service_stats": {
      "user-service": 5,
      "order-service": 7,
      "product-service": 3
    },
    "timestamp": "2023-10-27T13:30:00Z"
  }
}
```

---

### 3.3 è·å–æŒ‡å®šæœåŠ¡çš„ç»Ÿè®¡ä¿¡æ¯

- **GET** `/registry/services/:serviceName/stats`
- **æè¿°**: è·å–æŒ‡å®šæœåŠ¡çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬å®ä¾‹åˆ—è¡¨ã€åè®®åˆ†å¸ƒç­‰ã€‚
- **è®¤è¯**: éœ€è¦

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceName`| `string` | æœåŠ¡åç§°ã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "service_name": "user-service",
    "total_instances": 5,
    "healthy_instances": 5,
    "unhealthy_instances": 0,
    "protocols": {
      "http": 3,
      "grpc": 2
    },
    "statuses": {
      "active": 5
    },
    "instances": [ ... ], // è¯¦ç»†å®ä¾‹åˆ—è¡¨
    "timestamp": "2023-10-27T13:35:00Z"
  }
}
```

---

## 4. ç®¡ç†å‘˜åŠŸèƒ½

### 4.1 è·å–æ‰€æœ‰æœåŠ¡è¯¦ç»†ä¿¡æ¯

- **GET** `/registry/admin/all`
- **æè¿°**: è·å–æ‰€æœ‰æœåŠ¡çš„å®Œæ•´å®ä¾‹åˆ—è¡¨ï¼Œä»¥æœåŠ¡åç§°åˆ†ç»„ã€‚
- **è®¤è¯**: éœ€è¦ **ç®¡ç†å‘˜è§’è‰²**

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "user-service": [
      {
        "id": "user-service-b2f7a9a8-c2b1-4a8a-9f0a-4f1e5e3b2e1a",
        ...
      }
    ],
    "order-service": [
      {
        "id": "order-service-c3d4e5f6-a1b2-c3d4-e5f6-789012abcdef",
        ...
      }
    ]
  }
}
```

---

### 4.2 åˆ é™¤æŒ‡å®šæœåŠ¡çš„æ‰€æœ‰å®ä¾‹

- **DELETE** `/registry/admin/services/:serviceName`
- **æè¿°**: å¼ºåˆ¶æ³¨é”€æŒ‡å®šæœåŠ¡åç§°ä¸‹çš„æ‰€æœ‰å®ä¾‹ã€‚è¿™æ˜¯ä¸€ä¸ªå±é™©æ“ä½œã€‚
- **è®¤è¯**: éœ€è¦ **ç®¡ç†å‘˜è§’è‰²**

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° |
| :--- | :--- | :--- |
| `serviceName`| `string` | æœåŠ¡åç§°ã€‚ |

#### æˆåŠŸå“åº” (200 OK)

```json
{
  "code": 20000,
  "msg": "success",
  "data": {
    "service_name": "user-service",
    "total_instances": 5,
    "removed_count": 5,
    "errors": []
  }
}
```

#### éƒ¨åˆ†å¤±è´¥å“åº”

å¦‚æœéƒ¨åˆ†å®ä¾‹åˆ é™¤å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç ä»å¯èƒ½æ˜¯æˆåŠŸçš„ï¼Œä½†å“åº”ä½“ä¼šåŒ…å«é”™è¯¯ä¿¡æ¯ã€‚

```json
{
  "code": 50000,
  "msg": "éƒ¨åˆ†åˆ é™¤å¤±è´¥ï¼Œè¯¦æƒ…è¯·æŸ¥çœ‹å“åº”æ•°æ®",
  "data": {
    "service_name": "user-service",
    "total_instances": 5,
    "removed_count": 4,
    "errors": [
      "åˆ é™¤å®ä¾‹ user-service-... å¤±è´¥: <åŸå› >"
    ]
  }
}
``` 